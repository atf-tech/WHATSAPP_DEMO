<style>
  .chat-header {
    background: #ededed;
    padding: 10px;
    font-weight: bold;
  }

  .messages {
    height: 65vh;
    overflow-y: auto;
    padding: 10px;
    background: #e5ddd5;
  }

  .msg {
    margin-bottom: 8px;
    padding: 8px 10px;
    border-radius: 6px;
    max-width: 70%;
    clear: both;
  }

  .msg.in {
    background: white;
    float: left;
  }

  .msg.out {
    background: #dcf8c6;
    float: right;
  }

  .input-box {
    background: #f0f0f0;
    padding: 10px;
    display: flex;
  }

  .input-box input {
    flex: 1;
    padding: 10px;
    border: none;
  }

  .input-box button {
    padding: 10px;
    background: #25d366;
    border: none;
    color: white;
  }
</style>

<div class="chat-header">
  {{ conversation.donor.phone_number }}
</div>

<div class="messages" id="messages">
  {% include "chat/partials/messages.html" %}
</div>


<form class="input-box"
      hx-post="{% url 'send-message' conversation.id %}"
      hx-swap="none"
      hx-on="htmx:afterRequest:this.reset()">

  {% csrf_token %}
  <input type="text" name="text" placeholder="Type a message..." required>
  <button type="submit">Send</button>
</form>
<script>
  const messagesBox = document.getElementById("messages");

  function scrollToBottom() {
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }

  scrollToBottom();

  const socket = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    window.location.host +
    "/ws/chat/{{ conversation.id }}/"
  );

  socket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    // ðŸ›‘ safety
    if (!data.body || !data.direction || !data.time) return;

    const msg = document.createElement("div");
    msg.classList.add("msg", data.direction);

    const body = document.createElement("div");
    body.textContent = data.body;

    const time = document.createElement("div");
    time.style.fontSize = "11px";
    time.style.color = "#666";
    time.style.textAlign = "right";

    time.textContent = data.time;


    msg.appendChild(body);
    msg.appendChild(time);
    messagesBox.appendChild(msg);

    scrollToBottom();
  };
</script>
