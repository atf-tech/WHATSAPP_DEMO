{% extends "chat/base.html" %}
{% block content %}

<style>
  .container {
    display: flex;
    height: calc(100vh - 50px);
  }

  .sidebar {
    width: 30%;
    background: white;
    border-right: 1px solid #ddd;
    overflow-y: auto;
  }

  .chat-area {
    width: 70%;
    background: #e5ddd5;
  }

  .chat-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }

  .chat-item:hover {
    background: #f5f5f5;
  }

  .chat-item.active {
    background: #e9edef;
  }

  .phone {
    font-weight: bold;
  }

  .preview {
    font-size: 13px;
    color: #555;
  }
</style>

<div class="container">

  <!-- LEFT: INBOX -->
  <div class="sidebar" id="inbox-list">
    {% for convo in conversations %}
      <div class="chat-item"
           hx-get="{% url 'conversation' convo.id %}"
           hx-target="#chat-box"
           hx-swap="innerHTML"
           hx-on="click:
              document.querySelectorAll('.chat-item')
                .forEach(i => i.classList.remove('active'));
              this.classList.add('active');">

        <div class="phone">{{ convo.donor.phone_number }}</div>

        <div class="preview">
          {{ convo.last_message_preview|default:"No messages yet" }}
        </div>

      </div>
    {% empty %}
      <p style="padding:15px;">No conversations</p>
    {% endfor %}
  </div>

  <!-- RIGHT: CHAT -->
  <div class="chat-area" id="chat-box">
    <p style="padding:20px;">Select a conversation</p>
  </div>

</div>

<!-- SINGLE, HTMX-SAFE WEBSOCKET SCRIPT -->
<script>
document.addEventListener("htmx:afterSwap", function (e) {
    if (!e.target || e.target.id !== "chat-box") return;

    const chatContainer = e.target.querySelector("#chat-container");
    if (!chatContainer) return;

    const conversationId = chatContainer.dataset.conversationId;
    if (!conversationId) return;

    if (window.chatSocket) {
        window.chatSocket.close();
    }

    const protocol = location.protocol === "https:" ? "wss://" : "ws://";

    window.chatSocket = new WebSocket(
        protocol + window.location.host + "/ws/chat/" + conversationId + "/"
    );

    window.chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (!data.body || !data.direction || !data.time) return;

        const messagesBox = document.getElementById("messages");
        if (!messagesBox) return;

        const msg = document.createElement("div");
        msg.classList.add("msg", data.direction);

        const body = document.createElement("div");
        body.textContent = data.body;

        const time = document.createElement("div");
        time.style.fontSize = "11px";
        time.style.color = "#666";
        time.style.textAlign = "right";
        time.textContent = data.time;

        msg.appendChild(body);
        msg.appendChild(time);
        messagesBox.appendChild(msg);

        messagesBox.scrollTop = messagesBox.scrollHeight;
    };
});
</script>

{% endblock %}
